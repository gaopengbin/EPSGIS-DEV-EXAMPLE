/* 2023-8-11 09:34:00 | 版权所有 山维科技 http://www.sunwaysurvey.com.cn */
function bindLayerPopup2(){graphicLayer.bindPopup(function(e){var t=getAttrForEvent(e);return t["类型"]=null==(e=e.graphic)?void 0:e.type,t["来源"]="我是layer上绑定的Popup",t["备注"]="我支持鼠标交互",mars3d.Util.getTemplateHtml({title:"矢量图层",template:"all",attr:t})},{pointerEvents:!0})}function bindLayerContextMenu2(){graphicLayer.bindContextMenu([{text:"开始编辑对象",icon:"fa fa-edit",show:function(e){e=e.graphic;return!(!e||!e.hasEdit||e.isEditing)},callback:function(e){e=e.graphic;if(!e)return!1;e&&graphicLayer.startEditing(e)}},{text:"停止编辑对象",icon:"fa fa-edit",show:function(e){e=e.graphic;return!(!e||!e.hasEdit)&&e.isEditing},callback:function(e){e=e.graphic;if(!e)return!1;e&&e.stopEditing()}},{text:"删除对象",icon:"fa fa-trash-o",show:function(e){e=e.graphic;return!(!e||e.isDestroy)},callback:function(e){var t,e=e.graphic;e&&(t=e.parent,graphicLayer.removeGraphic(e),t)&&graphicLayer.removeGraphic(t)}},{text:"计算长度",icon:"fa fa-medium",show:function(e){e=e.graphic;return!!e&&("polyline"===e.type||"polylineP"===e.type||"curve"===e.type||"curveP"===e.type||"polylineVolume"===e.type||"polylineVolumeP"===e.type||"corridor"===e.type||"corridorP"===e.type||"wall"===e.type||"wallP"===e.type)},callback:function(e){e=e.graphic,e=mars3d.MeasureUtil.formatDistance(e.distance);haoutil.alert("该对象的长度为:"+e)}},{text:"计算周长",icon:"fa fa-medium",show:function(e){e=e.graphic;return!!e&&("circle"===e.type||"circleP"===e.type||"rectangle"===e.type||"rectangleP"===e.type||"polygon"===e.type||"polygonP"===e.type)},callback:function(e){e=e.graphic,e=mars3d.MeasureUtil.formatDistance(e.distance);haoutil.alert("该对象的周长为:"+e)}},{text:"计算面积",icon:"fa fa-reorder",show:function(e){e=e.graphic;return!!e&&("circle"===e.type||"circleP"===e.type||"rectangle"===e.type||"rectangleP"===e.type||"polygon"===e.type||"polygonP"===e.type||"scrollWall"===e.type||"water"===e.type)},callback:function(e){e=e.graphic,e=mars3d.MeasureUtil.formatArea(e.area);haoutil.alert("该对象的面积为:"+e)}}])}function getAttrForEvent(e){var t;return null!=e&&null!=(t=e.graphic)&&t.attr?e.graphic.attr:e.czmObject&&null!=(e=t=(t=e.czmObject._attr||e.czmObject.properties||e.czmObject.attribute)&&t.type&&t.attr?t.attr:t)?e:{}}function onClickAddRandomGraohic(e){haoutil.loading.show();var t=(new Date).getTime(),a=addRandomGraphicByCount(e);haoutil.loading.close();t=((new Date).getTime()-t)/1e3;window.layer.msg("生成".concat(a||e,"条数据，共耗时").concat(t.toFixed(2),"秒")),graphicLayer.flyTo({duration:0,heading:0,pitch:-40,scale:1.2})}function onClickImpFile(e){var t,a=e.name,a=a.substring(a.lastIndexOf(".")+1,a.length).toLowerCase();"json"==a||"geojson"==a?((t=new FileReader).readAsText(e,"UTF-8"),t.onloadend=function(e){var t=JSON.parse(this.result);"graphic"==t.type&&t.data?(graphicLayer.addGraphic(t.data),graphicLayer.flyTo()):(t=simplifyGeoJSON(t),graphicLayer.loadGeoJSON(t,{flyTo:!0})),clearSelectFile(),refreshTabel(graphicLayer)}):"kml"==a?((t=new FileReader).readAsText(e,"UTF-8"),t.onloadend=function(e){var t=this.result;kgUtil.toGeoJSON(t).then(function(e){e=simplifyGeoJSON(e),console.log("kml2geojson",e),graphicLayer.loadGeoJSON(e,{flyTo:!0}),clearSelectFile()}),clearSelectFile()}):"kmz"==a?kgUtil.toGeoJSON(e).then(function(e){e=simplifyGeoJSON(e),console.log("kmz2geojson",e),graphicLayer.loadGeoJSON(e,{flyTo:!0}),clearSelectFile()}):(window.layer.msg("暂不支持 "+a+" 文件类型的数据！"),clearSelectFile())}function clearSelectFile(){window.addEventListener?document.getElementById("input_draw_file").value="":document.getElementById("input_draw_file").outerHTML+=""}function simplifyGeoJSON(e){try{e=turf.simplify(e,{tolerance:1e-6,highQuality:!0,mutate:!0})}catch(e){}return e}function expGeoJSONFile(){var e;0===graphicLayer.length?window.layer.msg("当前没有标注任何数据，无需保存！"):(e=graphicLayer.toGeoJSON(),haoutil.file.downloadFile("矢量数据GeoJSON.json",JSON.stringify(e)))}function expJSONFile(){var e;0===graphicLayer.length?window.layer.msg("当前没有标注任何数据，无需保存！"):(e=graphicLayer.toJSON(),mars3d.Util.downloadFile("矢量数据构造参数.json",JSON.stringify(e)))}function bindAttributePannel(){$("#graphicTable")&&graphicLayer.readyPromise.then(function(e){getTableData(graphicLayer)}),graphicLayer.on(mars3d.EventType.drawCreated,function(e){$("#hasEdit").is(":checked")&&showEditor(e)}),graphicLayer.on([mars3d.EventType.editStart,mars3d.EventType.editStyle,mars3d.EventType.editAddPoint,mars3d.EventType.editMovePoint,mars3d.EventType.editRemovePoint],function(e){showEditor(e)}),graphicLayer.on([mars3d.EventType.editStop,mars3d.EventType.removeGraphic],function(e){setTimeout(function(){graphicLayer.isEditing||stopEditing()},100)})}var timeTik;function showEditor(e){var e=e.graphic,t=(clearTimeout(timeTik),e._conventStyleJson||(e.options.style=e.toJSON().style,e._conventStyleJson=!0),mars3d.widget.getClass("widgets/plotAttr/widget.js"));t&&t.isActivate?t.startEditing(e,e.coordinates):0===$("#infoview-left").length&&mars3d.widget.activate({map:map,uri:"widgets/plotAttr/widget.js",name:"属性编辑",graphic:e,lonlats:e.coordinates})}function stopEditing(){timeTik=setTimeout(function(){mars3d.widget&&mars3d.widget.disable("widgets/plotAttr/widget.js")},200)}var tableEventTarget=new mars3d.BaseClass;function tableInit(e){$("#graphicTable").bootstrapTable({data:e,pagination:!0,pageList:[3,5,10],singleSelect:!1,checkboxHeader:!1,columns:[{title:"是否显示",field:"show",align:"center",checkbox:!0,width:50,formatter:function(e,t,a){return{checked:!0}}},{field:"name",title:"名称"},{title:"操作",align:"center",width:80,events:{"click .remove":function(e,t,a,i){a=graphicLayer.getGraphicById(a.id);graphicLayer.removeGraphic(a),0<$("#infoview-left").length&&$("#infoview-left").hide()},"click .edit":function(e,t,a,i){a=getGraphic(a.id);0<$("#infoview-left").length?$("#infoview-left").show():showEditor({graphic:a})}},formatter:function(e,t,a){return['<a class="edit" href="javascript:void(0)" title="编辑"><i class="fa fa-edit"></i></a>&nbsp;&nbsp;','<a class="remove" href="javascript:void(0)" title="删除"><i class="fa fa-trash"></i></a>'].join("")}}],onClickRow:function(e){flyToTableItem(e.id)},onCheck:function(e){onSelectTableItem(e.id,!0)},onUncheck:function(e){onSelectTableItem(e.id,!1)}})}function refreshTabel(e){e=getDataByLayer(e);$("#graphicTable").bootstrapTable("load",e)}function removeTableItem(e){$("#graphicTable").bootstrapTable("remove",{field:"id",values:e})}function flyToTableItem(e){e=graphicLayer.getGraphicById(e);e&&e.flyTo()}function onSelectTableItem(e,t){e=graphicLayer.getGraphicById(e);e&&(t?(e.show=!0,e.flyTo()):e.show=!1)}function getTableData(t){t.on(mars3d.EventType.removeGraphic,function(e){removeTableItem(e.graphic.id)}),t.on(mars3d.EventType.drawCreated,function(e){refreshTabel(t)}),tableInit(getDataByLayer(t))}var graphicIndex=0;function getItemName(e){var t;if(null!=e&&null!=(t=e.style)&&null!=(t=t.label)&&t.text)return"".concat(e.type," - ").concat(e.style.label.text);if(!e.name){if(e.attr.remark)return"".concat(e.type," - ").concat(e.attr.remark);e.name="未命名".concat(++graphicIndex)}return"".concat(e.type," - ").concat(e.name)}function getDataByLayer(e){var e=e.getGraphics(),t=[];return e.forEach(function(e){e={id:e.id,name:getItemName(e),type:e.type,show:!0};t.push(e)}),t}