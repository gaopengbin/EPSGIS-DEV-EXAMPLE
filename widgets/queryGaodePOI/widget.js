/* 2023-8-11 09:34:01 | 版权所有 山维科技 http://www.sunwaysurvey.com.cn */
function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,_toPropertyKey(r.key),r)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);i=i.call(t,e||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(i){var r=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(i);return _possibleConstructorReturn(this,r?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}!function(window,mars3d){var MyWidget=function(_mars3d$widget$BaseWi){"use strict";_inherits(MyWidget,_mars3d$widget$BaseWi);var _super=_createSuper(MyWidget);function MyWidget(){return _classCallCheck(this,MyWidget),_super.apply(this,arguments)}return _createClass(MyWidget,[{key:"resources",get:function(){return["view.css"]}},{key:"view",get:function(){return{type:"append",url:"view.html",parent:"body"}}},{key:"create",value:function(){this.storageName="mars3d_queryGaodePOI",this.pageSize=6,this.allpage=0,this.thispage=0,this.graphicLayer=new mars3d.layer.GraphicLayer({name:this.config.name,pid:99}),this.graphicLayer.bindPopup(function(t){var e,i,t=null==(t=t.graphic)?void 0:t.attr;if(t)return e='<div class="mars-popup-titile"><a href="https://www.amap.com/detail/'.concat(t.id,'"  target="_black" style="color: #ffffff; ">').concat(t.name,'</a></div><div class="mars-popup-content" >'),""!=(i=$.trim(t.tel))&&(e+="<div><label>电话</label>"+i+"</div>"),""!=(i=$.trim(t.address))&&(e+="<div><label>地址</label>"+i+"</div>"),t.type&&""!=(i=$.trim(t.type))&&(e+="<div><label>类别</label>"+i+"</div>"),e+"</div>"},{has3dtiles:!1}),this._queryPoi=new mars3d.query.GaodePOI({})}},{key:"winCreateOK",value:function(t,e){var i,r,a=this;"append"==t.type&&(i=this,$("#map-querybar img").each(function(t,e){$(e).attr("src",a.path+$(e).attr("src"))}),this.config.position&&$("#map-querybar").css(this.config.position),this.config.style&&$("#map-querybar").css(this.config.style),$("#txt_querypoi").click(function(){0===$.trim($(this).val()).length&&(i.hideAllQueryBarView(),i.showHistoryList())}),r=0,$("#txt_querypoi").bind("input propertychange",function(){clearTimeout(r),r=setTimeout(function(){a.hideAllQueryBarView(),a.clearLayers();var t=$.trim($("#txt_querypoi").val());0==t.length?a.showHistoryList():a.autoTipList(t,!0)},500)}),$("#btn_querypoi").click(function(){clearTimeout(r),a.hideAllQueryBarView();var t=$.trim($("#txt_querypoi").val());a.strartQueryPOI(t,!0)}),$("#txt_querypoi").bind("keydown",function(t){"13"==t.keyCode&&$("#btn_querypoi").click()}),$("#querybar_detail_back").click(function(){a.hideAllQueryBarView(),$("#querybar_resultlist_view").show()}))}},{key:"activate",value:function(){var t;this.map.addLayer(this.graphicLayer),(null==(t=this.map.controls.locationBar)?void 0:t.container)&&(this.queryAddressDOM=mars3d.DomUtil.create("div","mars3d-locationbar-content mars3d-locationbar-autohide",this.map.controls.locationBar.container),this.queryAddressDOM.style.marginRight="50px"),this.map.on(mars3d.EventType.clickMap,this.onMapClick,this),this.map.on(mars3d.EventType.cameraChanged,this.onMapCameraChanged,this),this.onMapCameraChanged()}},{key:"disable",value:function(){this.map.removeLayer(this.graphicLayer),this.map.off(mars3d.EventType.clickMap,this.onMapClick,this),this.map.off(mars3d.EventType.cameraChanged,this.onMapCameraChanged,this),this.queryAddressDOM&&(mars3d.DomUtil.remove(this.queryAddressDOM),delete this.queryAddressDOM),this.hideAllQueryBarView(),this.clearLayers()}},{key:"onMapClick",value:function(t){0==$.trim($("#txt_querypoi").val()).length&&(this.hideAllQueryBarView(),$("#txt_querypoi").blur())}},{key:"onMapCameraChanged",value:function(t){var e=this;1e5<this.map.camera.positionCartographic.height?(this.address=null,this.queryAddressDOM.innerHTML=""):this._queryPoi.getAddress({location:this.map.getCenter(),success:function(t){e.address=t,e.queryAddressDOM.innerHTML="地址："+t.address}})}},{key:"hideAllQueryBarView",value:function(){$("#querybar_histroy_view").hide(),$("#querybar_autotip_view").hide(),$("#querybar_resultlist_view").hide()}},{key:"autoSearch",value:function(t){$("#txt_querypoi").val(t),$("#btn_querypoi").trigger("click")}},{key:"autoTipList",value:function(t,e){this.isLonLat(t)||(this.hasExWidget()&&e?this.autoExTipList(t):this._queryPoi.autoTip({text:t,city:null==(e=this.address)?void 0:e.city,location:this.map.getCenter(),success:function(t){for(var e="",i=t.list,r=0;r<i.length;r++){var a=i[r].name;e+="<li><i class='fa fa-search'></i><a href=\"javascript:queryGaodePOIWidget.autoSearch('"+a+"');\">"+a+"</a></li>"}0<e.length&&($("#querybar_ul_autotip").html(e),$("#querybar_autotip_view").show())}}))}},{key:"strartQueryPOI",value:function(t,e){0==t.length?toastr.warning("请输入搜索关键字！"):(this.addHistory(t),this.hideAllQueryBarView(),this.isLonLat(t)?this.centerAtLonLat(t):this.hasExWidget()&&e?this.queryExPOI(t):(this.thispage=1,this.queryText=t,this.query_city=null==(e=this.address)?void 0:e.city,this.queryTextByServer()))}},{key:"queryTextByServer",value:function(){var e=this;this._queryPoi.queryText({text:this.queryText,count:this.pageSize,page:this.thispage-1,city:this.query_city,success:function(t){e.isActivate&&e.showPOIPage(t.list,t.allcount)}})}},{key:"showPOIPage",value:function(t,e){e<t.length&&(e=t.length),this.allpage=Math.ceil(e/this.pageSize);var i="";if(0==e)i+='<div class="querybar-page"><div class="querybar-fl">没有找到"<strong>'+this.queryText+'</strong>"相关结果</div></div>';else{this.objResultData=this.objResultData||{};for(var r=0;r<t.length;r++){var a=t[r],s=(this.thispage-1)*this.pageSize,s=(a.index=s+(r+1),r);i+='<div class="querybar-site" onclick="queryGaodePOIWidget.showDetail(\''.concat(s,'\')">\n            <div class="querybar-sitejj">\n              <h3>').concat(a.index,"、").concat(a.name,'\n              <a id="btnShowDetail" href="https://www.amap.com/detail/').concat(a.id,'" target="_blank" class="querybar-more">更多&gt;</a> </h3>\n              <p> ').concat(a.address||"","</p>\n            </div>\n          </div> "),this.objResultData[s]=a}i+='<div class="querybar-page"><div class="querybar-fl">找到<strong>'+e+"</strong>条结果</div>"+(1<this.allpage?'<div class="querybar-ye querybar-fr">'+this.thispage+"/"+this.allpage+'页  <a href="javascript:queryGaodePOIWidget.showFirstPage()">首页</a> <a href="javascript:queryGaodePOIWidget.showPretPage()">&lt;</a>  <a href="javascript:queryGaodePOIWidget.showNextPage()">&gt;</a> </div>':"")+"</div>"}$("#querybar_resultlist_view").html(i),$("#querybar_resultlist_view").show(),this.showPOIArr(t),1==e&&this.showDetail("0")}},{key:"showFirstPage",value:function(){this.thispage=1,this.queryTextByServer()}},{key:"showNextPage",value:function(){this.thispage=this.thispage+1,this.thispage>this.allpage?(this.thispage=this.allpage,toastr.warning("当前已是最后一页了")):this.queryTextByServer()}},{key:"showPretPage",value:function(){this.thispage=this.thispage-1,this.thispage<1?(this.thispage=1,toastr.warning("当前已是第一页了")):this.queryTextByServer()}},{key:"showDetail",value:function(t){t=this.objResultData[t];this.flyTo(t)}},{key:"clearLayers",value:function(){this.graphicLayer.closePopup(),this.graphicLayer.clear()}},{key:"showPOIArr",value:function(t){var r=this;this.clearLayers(),t.forEach(function(t){var e=Number(t.lng),i=Number(t.lat);isNaN(e)||isNaN(i)||(t.lng=e,t.lat=i,e=new mars3d.graphic.PointEntity({position:Cesium.Cartesian3.fromDegrees(e,i),style:{pixelSize:10,color:"#3388ff",outline:!0,outlineColor:"#ffffff",outlineWidth:2,scaleByDistance:new Cesium.NearFarScalar(1e3,1,1e6,.1),clampToGround:!0,visibleDepth:!1,label:{text:t.name,font_size:20,color:"rgb(240,255,255)",outline:!0,outlineWidth:2,outlineColor:Cesium.Color.BLACK,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,pixelOffsetY:-10,distanceDisplayCondition:new Cesium.DistanceDisplayCondition(0,2e5),clampToGround:!0,visibleDepth:!1}},attr:t}),r.graphicLayer.addGraphic(e),t._graphic=e)}),1<t.length&&this.graphicLayer.flyTo()}},{key:"flyTo",value:function(t){var e=this,i=t._graphic;null==i?window.toastr.warning(t.name+" 无经纬度坐标信息！"):(this.map.flyToGraphic(i,{radius:2e3}),setTimeout(function(){e.graphicLayer.openPopup(i)},3e3))}},{key:"isLonLat",value:function(t){return/^-?((0|1?[0-7]?[0-9]?)(([.][0-9]*)?)|180(([.][0]*)?)),-?((0|[1-8]?[0-9]?)(([.][0-9]*)?)|90(([.][0]*)?))$/.test(t)}},{key:"centerAtLonLat",value:function(t){var e,i,t=t.split(",");2!=t.length||(e=Number(t[0]),t=Number(t[1]),isNaN(e))||isNaN(t)||(i=new mars3d.graphic.PointEntity({position:Cesium.Cartesian3.fromDegrees(e,t),style:{color:"#3388ff",pixelSize:10,outline:!0,outlineColor:"#ffffff",outlineWidth:2,scaleByDistance:new Cesium.NearFarScalar(1e3,1,1e6,.1),clampToGround:!0,visibleDepth:!1}}),this.graphicLayer.addGraphic(i),i.bindPopup('<div class="mars-popup-titile">坐标定位</div>\n              <div class="mars-popup-content" >\n                <div><label>经度</label> '.concat(e,"</div>\n                <div><label>纬度</label>").concat(t,"</div>\n              </div>")),i.openHighlight(),i.flyTo({radius:1e3,scale:1.5,complete:function(){i.openPopup()}}))}},{key:"showHistoryList",value:function showHistoryList(){var _this6=this;$("#querybar_histroy_view").hide(),localforage.getItem(this.storageName).then(function(laststorage){if(null!=laststorage&&(_this6.arrHistory=eval(laststorage),null!=_this6.arrHistory&&0!=_this6.arrHistory.length)){for(var inhtml="",index=_this6.arrHistory.length-1;0<=index;index--){var item=_this6.arrHistory[index];inhtml+="<li><a href=\"javascript:queryGaodePOIWidget.autoSearch('"+item+"');\">"+item+"</a></li>"}$("#querybar_ul_history").html(inhtml),$("#querybar_histroy_view").show()}})}},{key:"clearHistory",value:function(){this.arrHistory=[],localforage.removeItem(this.storageName),$("#querybar_ul_history").html(""),$("#querybar_histroy_view").hide()}},{key:"addHistory",value:function addHistory(data){var _this7=this;this.arrHistory=[],localforage.getItem(this.storageName).then(function(laststorage){null!=laststorage&&(_this7.arrHistory=eval(laststorage)),haoutil.array.remove(_this7.arrHistory,data),_this7.arrHistory.push(data),10<_this7.arrHistory.length&&_this7.arrHistory.splice(0,1),localforage.setItem(_this7.storageName,_this7.arrHistory)})}},{key:"hasExWidget",value:function(){return null!=window.queryBarWidget&&(this.exWidget=window.queryBarWidget,!0)}},{key:"autoExTipList",value:function(t){var e=this;this.exWidget.autoTipList(t,function(){e.autoTipList(t,!1)})}},{key:"queryExPOI",value:function(t){var e=this,i=this.graphicLayer;this.exWidget.strartQueryPOI(t,i,function(){e.strartQueryPOI(t,!1)})}}]),MyWidget}(mars3d.widget.BaseWidget);window.queryGaodePOIWidget=mars3d.widget.bindClass(MyWidget)}(window,mars3d);