/* 2023-8-11 09:34:01 | 版权所有 山维科技 http://www.sunwaysurvey.com.cn */
function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ownKeys(e,t){var a,l=Object.keys(e);return Object.getOwnPropertySymbols&&(a=Object.getOwnPropertySymbols(e),t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),l.push.apply(l,a)),l}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach(function(t){_defineProperty(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}function _defineProperty(t,e,a){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0===a)return("string"===e?String:Number)(t);a=a.call(t,e||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}var thisWidget;function initWidgetView(t){thisWidget=t,$("#btnDelete").click(function(){thisWidget.deleteEntity()}),$("#btnCenter").click(function(t){thisWidget.centerCurrentEntity()}),$("#btn_plot_savefile").click(function(){var t=thisWidget.getGeoJson();haoutil.file.downloadFile("标绘item.json",JSON.stringify(t))}),plotEdit.initEvent(),thisWidget.startEditing()}var newAttr={},plotEdit={hasEditSylte:!0,initEvent:function(){this.hasEditSylte||$("#attr_style_view").hide(),$("#plot_latlngs_allheight").bind("input propertychange",function(){$("#plot_latlngs_addheight").val("");for(var t=Number($(this).val()),e=(isNaN(t)&&(t=1),[]),a=($(".plot_latlngs").each(function(){"height"==$(this).attr("data-type")?($(this).val(t),e.push(t)):e.push(Number($(this).val()))}),[]),l=0;l<e.length;l+=3)a.push([e[l],e[l+1],e[l+2]]);thisWidget.updatePoints2map(a)}),$("#plot_latlngs_addheight").bind("input propertychange",function(){$("#plot_latlngs_allheight").val("");for(var e=Number($(this).val()),a=(isNaN(e)&&(e=1),[]),t=($(".plot_latlngs").each(function(){var t;"height"==$(this).attr("data-type")?(t=Number($(this).attr("oldvalue")),$(this).val(t+e),a.push(t+e)):a.push(Number($(this).val()))}),[]),l=0;l<a.length;l+=3)t.push([a[l],a[l+1],a[l+2]]);thisWidget.updatePoints2map(t)})},_last_attr:null,startEditing:function(r,t){var s=this;if(window.styleConfig){r&&r.attr&&(r=_objectSpread(_objectSpread({},r),r.attr)),this._last_attr=r;var o=window.styleConfig[r.type]||window.styleConfig[r.styleType]||{},p=(o.style=o.style||{},t&&(this._hasHeight=!0,!r.style.clampToGround&&"rectangle"!=r.type&&"corridor"!=r.type||(this._hasHeight=!1),this.updateLatlngsHtml(t)),[]);if(this.hasEditSylte){u="plot_attr_style_",c='<tr><td class="nametd">所在图层：</td><td>'.concat(thisWidget.getLayerName()||"默认图层",'</td></tr>\n      <tr><td class="nametd">标号类型：</td><td>').concat(r.type,'</td></tr>\n      <tr><td class="nametd">样式类型：</td><td>').concat(o.type||"未配置","</td></tr>");for(var d=0;d<o.style.length;d++)!function(){var t=o.style[d];if(!x(t,r.style))return;var l,n,e,a=t.name,i=null!=(e=r.style[a])?e:t.defval;"materialType"===t.name?(i=s._materialType_selectd||i,(e=s.getAttrInput(u,a,i,t)).fun&&p.push({parname:u,name:a,value:i,edit:t,fun:e.fun}),c+='<tr  id="'+u+"tr_"+a+'" > <td class="nametd">'+t.label+"</td>  <td>"+e.html+"</td>  </tr>",t.data.forEach(function(t){t.value===i&&(l=t.defval||{})}),n=r.style.materialOptions||{},window.materialConfig[i.split("-")[0]].forEach(function(t){var e,a;x(t,n)&&(e="plot_attr_style_mat",n[t.name]=null!=(a=null!=(a=null!=(a=n[t.name])?a:r.style[t.name])?a:l[t.name])?a:t.defval,(a=s.getAttrInput(e,t.name,n[t.name],t)).fun&&p.push({parname:e,name:t.name,value:n[t.name],edit:t,fun:a.fun}),c+='<tr  id="'+e+"tr_"+t.name+'" > <td class="nametd">'+t.label+"</td>  <td>"+a.html+"</td>  </tr>")})):((e=s.getAttrInput(u,a,i,t)).fun&&p.push({parname:u,name:a,value:i,edit:t,fun:e.fun}),c+='<tr  id="'+u+"tr_"+a+'" > <td class="nametd">'+t.label+"</td>  <td>"+e.html+"</td>  </tr>")}();if($("#talbe_style").html(c),r.style.label){for(var e=window.styleConfig.label||{},u="plot_attr_stylelabel_",c="",a=0;a<e.style.length;a++){var l,n,i,h=e.style[a];x(h,r.style.label)&&(l=h.name,n=null!=(n=r.style.label[l])?n:h.defval,r.style.label[l]=n,(i=this.getAttrInput(u,l,n,h)).fun&&p.push({parname:u,name:l,value:n,edit:h,fun:i.fun}),c+='<tr  id="'+u+"tr_"+l+'" > <td class="nametd">'+h.label+"</td>  <td>"+i.html+"</td>  </tr>")}$("#talbe_stylelabel").html(c),$("#attr_stylelabel_view").show()}else $("#attr_stylelabel_view").hide()}u="plot_attr_attr_",c="",r.attr=r.attr||{};for(var m,f=thisWidget.getAttrList(),y={},g=0;g<f.length;g++)y[f[g].name]=!0;for(m in r.attr){var _=r.attr[m];y[m]||(haoutil.isutil.isString(_)?f.push({name:m,label:m,type:"text",defval:""}):haoutil.isutil.isNumber(_)?f.push({name:m,label:m,type:"number",defval:0}):"boolean"==typeof _&&f.push({name:m,label:m,type:"radio",defval:!1}))}for(var v=0;v<f.length;v++){var b,w,A,O=f[v];"hidden"!=O.type&&(b=O.name,w=null!=(w=null!=(w=r.attr[b])?w:O.defval)?w:"",(A=this.getAttrInput(u,b,w,O)).fun&&p.push({parname:u,name:b,value:w,edit:O,fun:A.fun}),c+='<tr  id="'+u+"tr_"+b+'" > <td class="nametd">'+O.label+"</td>  <td>"+A.html+"</td>  </tr>")}$("#talbe_attr").html(c);for(var N=0;N<p.length;N++){var k=p[N];k.fun(k.parname,k.name,k.value,k.edit)}window.tab2attr()}function x(t,e){return"function"!=typeof t.show||t.show(e,r.style,r.type)}},updateLatlngsHtml:function(t){$("#plot_latlngs_addheight").val(""),$("#plot_latlngs_allheight").val(""),$("#view_updateheight").hide();var e="";if(t&&0!=t.length)if(1==t.length){var a=t[0],l=a[0],n=a[1],a=3==a.length?a[2]:0;e+=' <div class="mp_attr" style=" margin-top: 10px;"><table> <tr> <td class="nametd">经度：</td> <td><input type="number" class="mp_input plot_latlngs" data-type="jd" step="0.000001"  value="'+l+'"></td></tr><tr>  <td class="nametd">纬度：</td> <td><input type="number" class="mp_input plot_latlngs" data-type="wd" step="0.000001"  value="'+n+'"></td></tr>',this._hasHeight&&(e+='<tr><td class="nametd">高程：</td> <td><input type="number" class="mp_input plot_latlngs" data-type="height" step="0.1" value="'+a+'" oldvalue="'+a+'"></td></tr>'),e+=" </table> </div>"}else{this._hasHeight&&$("#view_updateheight").show();var i="";t.length>thisWidget.getMinPointNum()&&(i='<i class="fa fa-trash-o latlng-del" title="删除点" ></i>');for(var r=0;r<t.length;r++){var s=t[r],o=s[0],p=s[1],s=3==s.length?s[2]:0,d="";e+='<div><div class="open"><i class="tree_icon">-</i>第'+(r+1)+'点 <label style="width:100px;">&nbsp;</label>    '+(d=t.length<thisWidget.getMaxPointNum()?'<i class="fa  fa-plus-square-o latlng-install" title="插入点" data-index="'+r+'" ></i>&nbsp;&nbsp;':d)+i+' </div><div class="mp_attr"><table><tr> <td class="nametd">经度：</td> <td><input  type="number" class="mp_input plot_latlngs" data-type="jd"  step="0.000001" data-index="'+r+'" value="'+o+'"></td>  </tr> <tr>  <td class="nametd">纬度：</td> <td><input  type="number" class="mp_input plot_latlngs" data-type="wd"  step="0.000001" data-index="'+r+'" value="'+p+'"></td> </tr> ',this._hasHeight&&(e+='<tr>  <td class="nametd">高程：</td> <td><input  type="number" step="0.1" class="mp_input plot_latlngs" data-type="height" data-index="'+r+'" value="'+s+'" oldvalue="'+s+'"></td> </tr> '),e+=" </table> </div> </div>"}}$("#view_latlngs").html(e),$("#view_latlngs .open").click(window.changeOpenShowHide);var u=this;$("#view_latlngs .latlng-del").click(function(){$(this).parent().parent().remove();var t=[],e=!1,a=($(".plot_latlngs").each(function(){t.push(Number($(this).val())),"height"===$(this).attr("data-type")&&(e=!0)}),[]);if(e)for(var l=0;l<t.length;l+=3)a.push([t[l],t[l+1],t[l+2]]);else for(var n=0;n<t.length;n+=2)a.push([t[n],t[n+1]]);u.updateLatlngsHtml(a),thisWidget.updatePoints2map(a)}),$("#view_latlngs .latlng-install").click(function(){var t=Number($(this).attr("data-index")),e=[],a=!1,l=($(".plot_latlngs").each(function(){e.push(Number($(this).val()||0)),"height"===$(this).attr("data-type")&&(a=!0)}),[]);if(a)for(var n=0;n<e.length;n+=3)l.push([e[n],e[n+1],e[n+2]]);else for(var i=0;i<e.length;i+=2)l.push([e[i],e[i+1]]);var r=l[t],s=t==l.length-1?l[0]:l[t+1],o=Number(((r[0]+s[0])/2).toFixed(6)),p=Number(((r[1]+s[1])/2).toFixed(6));a?(r=Number(((r[2]+s[2])/2).toFixed(1)),l.splice(t+1,0,[o,p,r])):l.splice(t+1,0,[o,p]),u.updateLatlngsHtml(l),thisWidget.updatePoints2map(l)}),$(".plot_latlngs").bind("input propertychange",function(){var t=[],e=!1,a=($(".plot_latlngs").each(function(){t.push(Number($(this).val())),"height"===$(this).attr("data-type")&&(e=!0)}),[]);if(e)for(var l=0;l<t.length;l+=3)a.push([t[l],t[l+1],t[l+2]]);else for(var n=0;n<t.length;n+=2)a.push([t[n],t[n+1]]);thisWidget.updatePoints2map(a)})},getAttrInput:function(t,e,a,l){null==a&&(a="");var s=this,n="",i=null;switch(l.type){default:case"label":n=a;break;case"text":n='<input id="'+t+e+'" type="text" value="'+a+'"    class="mp_input" />',i=function(a,l,t,n){$("#"+a+l).on("input propertychange",function(t){var e=$(this).val();s.updateAttr(a,l,e,n)})};break;case"textarea":n='<textarea  id="'+t+e+'"     class="mp_input" style="height:50px;resize: none;" >'+(a=a.replace(new RegExp("<br />","gm"),"\n"))+"</textarea>",i=function(a,l,t,n){$("#"+a+l).on("input propertychange",function(t){var e=(e=0==(e=$(this).val()).length?"":e).replace(/\n/g,"<br />");s.updateAttr(a,l,e,n)})};break;case"number":n='<input id="'+t+e+'" type="number" value="'+(a||0)+'"    class="mp_input"/>',i=function(a,l,t,n){$("#"+a+l).on("input propertychange",function(t){var e=Number($(this).val());s.updateAttr(a,l,e,n)})};break;case"slider":i=1!==l.max?(n='<input id="'+t+e+'" type="number" value="'+(a||0)+'"    class="mp_input"/>',function(a,l,t,n){$("#"+a+l).on("input propertychange",function(t){var e=Number($(this).val());s.updateAttr(a,l,e,n)})}):(n='<input id="'+t+e+'"  type="text" value="'+100*a+'"   data-value="'+a+'" />',function(e,a,t,l){var n=.6*$(".mp_tab_card").width()-30;$("#"+e+a).progress(n),$("#"+e+a).change(function(){var t=Number($(this).val())/100;s.updateAttr(e,a,t,l)})});break;case"combobox":for(var n='<select id="'+t+e+'" class="mp_select"    data-value="'+a+'" >',r=0;r<l.data.length;r++){var o=l.data[r];n+='<option value="'+o.value+'">'+o.label+"</option>"}n+="</select>",i=function(n,i,t,r){var e;$("#"+n+i).select(),$("#"+n+i).change(function(){for(var t,e=$(this).attr("data-value"),a=0;a<r.data.length;a++){var l=r.data[a];null!=l.impact&&(l.value===e?t=l:s.changeViewByAttr(n,l.impact,!1))}t&&s.changeViewByAttr(n,t.impact,!0),"number"==r.valType&&(e=Number(e)),s.updateAttr(n,i,e,r)});for(var a=0;a<r.data.length;a++){var l=r.data[a];null!=l.impact&&(l.value===t?e=l:s.changeViewByAttr(n,l.impact,!1))}e&&s.changeViewByAttr(n,e.impact,!0)};break;case"radio":var p=t+e;n='<div class="radio radio-info radio-inline" id="'.concat(p,'"  data-value="').concat(a,'" >\n            <input type="radio" id="').concat(p,'_1" value="1"  name="').concat(p,'" ').concat(a?'checked="checked"':"",'>\n            <label for="').concat(p,'_1"> 是</label>\n          </div>\n          <div class="radio radio-info radio-inline">\n            <input type="radio" id="').concat(p,'_0" value="0" name="').concat(p,'" ').concat(a?"":'checked="checked"','">\n            <label for="').concat(p,'_0"> 否 </label>\n          </div>'),i=function(e,a,t,l){$('input:radio[name="'+e+a+'"]').change(function(){var t="1"==$(this).val();s.updateAttr(e,a,t,l)&&s.changeViewByAttr(e,l.impact,t)}),s.changeViewByAttr(e,l.impact,t)};break;case"color":n='<input id="'+t+e+'"  class="mp_input" style="width: 100%;"  value="'+a+'" />',i=function(a,l,t,n){$("#"+a+l).minicolors({position:"bottom right",control:"saturation",change:function(t,e){s.updateAttr(a,l,t,n)}})};break;case"window":n='<input id="'+t+e+'" type="text" value="'+a+'" readonly   class="mp_input" />',i=function(a,l,e,n){$("#"+a+l).on("click",function(t){thisWidget.showEditAttrWindow({data:s._last_attr,parname:a,attrName:l,attrVal:e})}),$("#"+a+l).on("input propertychange",function(t){var e=$(this).val();s.updateAttr(a,l,e,n)})}}return{html:n,fun:i}},changeViewByAttr:function(t,e,a){if(e&&0<e.length)for(var l=0;l<e.length;l++){var n=e[l];a?($("#"+t+"tr_"+n).show(),$("#"+t+n).attr("data-value")||$("#"+t+n).val()):$("#"+t+"tr_"+n).hide()}},updateAttr:function(t,e,a,l){switch(t){case"plot_attr_style_":var n,i={},r=(i[e]=a,this._last_attr.style[e]=a,this._last_attr.styleType||this._last_attr.type);if(!("fill"!=e&&"outline"!=e||!1!==a||"plane"!=r&&"circle"!=r&&"ellipse"!=r&&"cylinder"!=r&&"ellipsoid"!=r&&"box"!=r&&"polylineVolume"!=r&&"wall"!=r&&"corridor"!=r&&"rectangle"!=r&&"polygon"!=r))if(null!=(r=this._last_attr.style.fill)&&!r&&!this._last_attr.style.outline)return this._last_attr.style[e]=!0,$("input[name='"+t+e+"']:eq(0)").attr("checked","checked"),$("input[name='"+t+e+"']:eq(0)").click(),haoutil.msg("填充和边框不能同时为否，需要至少开启一个！"),!1;"materialType"===e?(i.materialOptions={},l.data.forEach(function(t){t.value===a&&(n=t.defval||{})}),a=(this._materialType_selectd=a).split("-")[0],window.materialConfig[a].forEach(function(t){var e;i.materialOptions[t.name]=null!=(e=n[t.name])?e:t.defval}),this._last_attr.style.materialOptions=i.materialOptions,i[e]=a,this._last_attr.style[e]=a,this.startEditing(this._last_attr)):"radio"==l.type&&this.startEditing(this._last_attr),thisWidget.updateStyle2map(i);break;case"plot_attr_style_mat":r={};r[e]=a,this._last_attr.style.materialOptions=this._last_attr.style.materialOptions||{},this._last_attr.style.materialOptions[e]=a,this.startEditing(this._last_attr),thisWidget.updateStyle2map({materialOptions:r});break;case"plot_attr_stylelabel_":r={};r[e]=a,this._last_attr.style.label=this._last_attr.style.label||{},this._last_attr.style.label[e]=a,"radio"==l.type&&this.startEditing(this._last_attr),thisWidget.updateStyle2map({label:r});break;case"plot_attr_attr_":this._last_attr.attr[e]=a,newAttr[e]=a,thisWidget.updateAttr2map(newAttr)}return!0}};