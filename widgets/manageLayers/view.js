/* 2023-8-11 09:34:01 | 版权所有 山维科技 http://www.sunwaysurvey.com.cn */
var thisWidget,lastRightClickTreeId,lastRightClickTreeNode,layers=[],layersObj={};function initWidgetView(e){thisWidget=e,bindRightMenuEvnet();for(var e={check:{enable:!0},data:{simpleData:{enable:!0}},callback:{onCheck:treeOverlays_onCheck,onRightClick:treeOverlays_OnRightClick,onDblClick:treeOverlays_onDblClick,onClick:treeOverlays_onClick},view:{addDiyDom:addOpacityRangeDom}},n=[],t=(layers=thisWidget.getLayers()).length-1;0<=t;t--){var d=_getNodeConfig(layers[t]);d&&n.push(d)}$.fn.zTree.init($("#treeOverlays"),e,n)}function _getNodeConfig(e){if(null!=e&&e.options&&!e.isPrivate){var n,t=e.options;if(t.name&&"未命名"!=t.name)return n={id:e.id,pId:e.pid,name:e.name,checked:e.isAdded&&e.show},e.hasEmptyGroup?(n.icon="img/folder.png",n.open=null==t.open||t.open):e.hasChildLayer?(n.icon="img/layerGroup.png",n.open=null==t.open||t.open):(n.icon="img/layer.png",e.parent&&(n._parentId=e.parent.id)),layersObj[n.id]=e,n;console.log("未命名图层不加入图层管理",e)}}function addNode(e){var n,t=$.fn.zTree.getZTreeObj("treeOverlays"),d=(e.pid&&-1!=e.pid&&(n=t.getNodeByParam("id",e.pid,null)),_getNodeConfig(e));d&&(t.addNodes(n,0,[d],!0),e.hasChildLayer)&&e.eachLayer(function(e){removeNode(e),addNode(e)})}function removeNode(e){var n=$.fn.zTree.getZTreeObj("treeOverlays"),e=n.getNodeByParam("id",e.id,null);e&&n.removeNode(e)}function updateNode(e){var n=$.fn.zTree.getZTreeObj("treeOverlays"),t=n.getNodeByParam("id",e.id,null),d=e.isAdded&&e.show;t?t.checked!=d&&(t.checkedOld=t.checked,t.checked=d,n.updateNode(t)):addNode(e,d)}function treeOverlays_onClick(e,n,t,d){}function treeOverlays_onDblClick(e,n,t){null!=t&&null!=t.id&&(t=layersObj[t.id])&&t.show&&t.flyTo()}function removeArrayItem(e,n){for(var t=0;t<e.length;t++)if(e[t]==n)return e.splice(t,1),!0;return!1}function treeOverlays_onCheck(e,n,t){var d=$.fn.zTree.getZTreeObj(n),a=d.getChangeCheckedNodes();removeArrayItem(a,t),a.push(t);for(var r=0;r<a.length;r++){var o=a[r];if(o.checkedOld=o.checked,1!=o.check_Child_State){var i=layersObj[o.id];if(null!=i){if(o.checked?$("#slider"+o.tId).css("display",""):$("#slider"+o.tId).css("display","none"),i.options.radio&&o.checked)for(var l=d.getNodesByFilter(function(e){var n=layersObj[e.id];return n.options.radio&&n.pid==i.pid&&e.id!=o.id},!1,o.getParentNode()),c=0;c<l.length;c++)l[c].checkedOld=!1,d.checkNode(l[c],!1,!0),$("#"+l[c].tId+"_range").hide(),layersObj[l[c].id].show=!1;thisWidget.updateLayerShow(i,o.checked)}}}n=layersObj[t.id];n&&thisWidget.checkClickLayer(n,t.checked)}function addOpacityRangeDom(e,n){var t,d,a=layersObj[n.id];a&&a.hasOpacity&&(t=$("#"+n.tId),d='<input id="'+n.tId+'_range" style="display:none" />',t.append(d),$("#"+n.tId+"_range").slider({id:"slider"+n.tId,min:0,max:100,step:1,value:100*(a.opacity||1)}).on("change",function(e){e=e.value.newValue/100;layersObj[n.id].opacity=e}),n.checked||$("#slider"+n.tId).css("display","none"))}function treeOverlays_OnRightClick(e,n,t){var d;null!=t&&(d=layersObj[t.id])&&d.hasZIndex&&(lastRightClickTreeId=n,lastRightClickTreeNode=t,d=e.clientY,n=e.clientX,(t=document.body.offsetHeight-100)<d&&(d=t),(e=document.body.offsetWidth-100)<n&&(n=e),$("#content_layer_manager_rMenu").css({top:d+"px",left:n+"px"}).show(),$("body").bind("mousedown",onBodyMouseDown))}function onBodyMouseDown(e){"content_layer_manager_rMenu"==e.target.id||0<$(e.target).parents("#content_layer_manager_rMenu").length||hideRMenu()}function hideRMenu(){$("body").unbind("mousedown",onBodyMouseDown),$("#content_layer_manager_rMenu").hide()}function bindRightMenuEvnet(){$("#content_layer_manager_rMenu li").on("click",function(){hideRMenu(),moveNodeAndLayer($(this).attr("data-type"))})}function moveNodeAndLayer(e){var n=$.fn.zTree.getZTreeObj(lastRightClickTreeId),t=lastRightClickTreeNode.getParentNode(),d=null==t?n.getNodes():t.children,a=lastRightClickTreeNode,r=layersObj[a.id];switch(e){case"up":var o=a.getPreNode();o&&(n.moveNode(o,a,"prev"),exchangeLayer(r,layersObj[o.id]));break;case"top":if(0==a.getIndex())return;for(;0<a.getIndex();){var i=a.getPreNode();i&&(n.moveNode(i,a,"prev"),exchangeLayer(r,layersObj[i.id]))}break;case"down":o=a.getNextNode();o&&(n.moveNode(o,a,"next"),exchangeLayer(r,layersObj[o.id]));break;case"bottom":if(a.getIndex()==d.length-1)return;for(;a.getIndex()<d.length-1;){var l=a.getNextNode();l&&(n.moveNode(l,a,"next"),exchangeLayer(r,layersObj[l.id]))}}layers.sort(function(e,n){return e.zIndex-n.zIndex})}function exchangeLayer(e,n){var t;null!=e&&null!=n&&(t=e.zIndex,e.zIndex=n.zIndex,n.zIndex=t,console.log("".concat(e.name,":").concat(e.zIndex,",  ").concat(n.name,":").concat(n.zIndex)))}function updateCheckd(e,n){var t=$.fn.zTree.getZTreeObj("treeOverlays"),d=t.getNodesByParam("name",e,null);d&&0<d.length?t.checkNode(d[0],n,!1):console.log("未在图层树上找到图层“"+e+"”，无法自动勾选处理")}